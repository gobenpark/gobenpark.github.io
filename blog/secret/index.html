<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>external secret 설치후기 | Ben Park</title>
<meta name=keywords content><meta name=description content="회사의 특정 GCP 프로젝트가 삭제되고 staging 환경에서 새로 argocd rollouts,linkerd, external secret operator등을 설치를 하려고한다.
개발환경에서 환경구축을 할 때 손수 매뉴얼하게 진행을 했었는데 이번에는 openTofu를 사용해서 진행을 해보았다
helm을 이용해서 external-secret operator를 설치
helm install external-secrets \ external-secrets/external-secrets \ -n external-secrets \ --create-namespace 이때 특정 ns(external-secrets)에 pod가 여러개가 생성이되고 해당 문서에서 처럼 workload identity를 사용하여 gcp인증을 진행해야된다.
특정 서비스 어카운트를 생성하고 해당 어카운트에 workload identity user와 secret manager 엑세스 권한을 넣어주는것을 opentofu로 진행을 했다."><meta name=author content><link rel=canonical href=https://gobenpark.github.io/blog/secret/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://gobenpark.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gobenpark.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gobenpark.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gobenpark.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gobenpark.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gobenpark.github.io/blog/secret/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="external secret 설치후기"><meta property="og:description" content="회사의 특정 GCP 프로젝트가 삭제되고 staging 환경에서 새로 argocd rollouts,linkerd, external secret operator등을 설치를 하려고한다.
개발환경에서 환경구축을 할 때 손수 매뉴얼하게 진행을 했었는데 이번에는 openTofu를 사용해서 진행을 해보았다
helm을 이용해서 external-secret operator를 설치
helm install external-secrets \ external-secrets/external-secrets \ -n external-secrets \ --create-namespace 이때 특정 ns(external-secrets)에 pod가 여러개가 생성이되고 해당 문서에서 처럼 workload identity를 사용하여 gcp인증을 진행해야된다.
특정 서비스 어카운트를 생성하고 해당 어카운트에 workload identity user와 secret manager 엑세스 권한을 넣어주는것을 opentofu로 진행을 했다."><meta property="og:type" content="article"><meta property="og:url" content="https://gobenpark.github.io/blog/secret/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-05-23T17:10:06+09:00"><meta property="article:modified_time" content="2024-05-23T17:10:06+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="external secret 설치후기"><meta name=twitter:description content="회사의 특정 GCP 프로젝트가 삭제되고 staging 환경에서 새로 argocd rollouts,linkerd, external secret operator등을 설치를 하려고한다.
개발환경에서 환경구축을 할 때 손수 매뉴얼하게 진행을 했었는데 이번에는 openTofu를 사용해서 진행을 해보았다
helm을 이용해서 external-secret operator를 설치
helm install external-secrets \ external-secrets/external-secrets \ -n external-secrets \ --create-namespace 이때 특정 ns(external-secrets)에 pod가 여러개가 생성이되고 해당 문서에서 처럼 workload identity를 사용하여 gcp인증을 진행해야된다.
특정 서비스 어카운트를 생성하고 해당 어카운트에 workload identity user와 secret manager 엑세스 권한을 넣어주는것을 opentofu로 진행을 했다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://gobenpark.github.io/blog/"},{"@type":"ListItem","position":2,"name":"external secret 설치후기","item":"https://gobenpark.github.io/blog/secret/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"external secret 설치후기","name":"external secret 설치후기","description":"회사의 특정 GCP 프로젝트가 삭제되고 staging 환경에서 새로 argocd rollouts,linkerd, external secret operator등을 설치를 하려고한다.\n개발환경에서 환경구축을 할 때 손수 매뉴얼하게 진행을 했었는데 이번에는 openTofu를 사용해서 진행을 해보았다\nhelm을 이용해서 external-secret operator를 설치\nhelm install external-secrets \\ external-secrets/external-secrets \\ -n external-secrets \\ --create-namespace 이때 특정 ns(external-secrets)에 pod가 여러개가 생성이되고 해당 문서에서 처럼 workload identity를 사용하여 gcp인증을 진행해야된다.\n특정 서비스 어카운트를 생성하고 해당 어카운트에 workload identity user와 secret manager 엑세스 권한을 넣어주는것을 opentofu로 진행을 했다.","keywords":[],"articleBody":"회사의 특정 GCP 프로젝트가 삭제되고 staging 환경에서 새로 argocd rollouts,linkerd, external secret operator등을 설치를 하려고한다.\n개발환경에서 환경구축을 할 때 손수 매뉴얼하게 진행을 했었는데 이번에는 openTofu를 사용해서 진행을 해보았다\nhelm을 이용해서 external-secret operator를 설치\nhelm install external-secrets \\ external-secrets/external-secrets \\ -n external-secrets \\ --create-namespace 이때 특정 ns(external-secrets)에 pod가 여러개가 생성이되고 해당 문서에서 처럼 workload identity를 사용하여 gcp인증을 진행해야된다.\n특정 서비스 어카운트를 생성하고 해당 어카운트에 workload identity user와 secret manager 엑세스 권한을 넣어주는것을 opentofu로 진행을 했다.\nresource \"google_service_account\" \"sa\" { account_id = \"external-secrets\" display_name = \"external-secrets\" project = var.project_id } resource \"google_service_account_iam_binding\" \"workload_identity_binding\" { service_account_id = google_service_account.sa.name role = \"roles/iam.workloadIdentityUser\" members = [ \"serviceAccount:${var.project_id}.svc.id.goog[external-secrets/external-secrets]\", ] } resource \"google_secret_manager_secret_iam_member\" \"secret_manager_access\" { project = var.project_id secret_id = \"projects//secrets/github-token\" role = \"roles/secretmanager.secretAccessor\" member = \"serviceAccount:${google_service_account.sa.email}\" } 해당 코드를 작성중 문뜩 개발환경을 말아먹은 때가 떠오르는데\n당시 테라폼 코드를 작성중 서비스 어카운트 생성에 google_project_iam_policy를 사용했었다 해당 문서에도 관련된 경고문구가 있었지만 당시에는 못보았다… 해당 리소스를 쓸경우 덮어씌워지는것도 아닌 내가 작성한 policy대로 초기화가된다. 즉 default service account는 물론 컴퓨트 엔진등 서비스 어카운트 모두 사라지게되니 조심하자.\n해당 tf파일을 apply한후\nkubernetes External secret과 secret store CRD를 모두 적용해주자\napiVersion: external-secrets.io/v1beta1 kind: ExternalSecret metadata: name: github-token spec: refreshInterval: 1h # rate SecretManager pulls GCPSM secretStoreRef: kind: ClusterSecretStore name: gcp-store # name of the SecretStore (or kind specified) target: name: database-credentials # name of the k8s Secret to be created creationPolicy: Owner data: - secretKey: github-token remoteRef: key: github-token # name of the GCPSM secret key # name of the GCPSM secret key apiVersion: external-secrets.io/v1beta1 kind: ClusterSecretStore metadata: name: gcp-store namespace: external-secrets spec: provider: gcpsm: projectID: \"project\" # config 다음 두개의 내용을 apply를 하게되면\nsecret이 생성이 되고. 해당 secret은 gcp secret manager에 등록된 시크릿이 보이게된다.\nexternal-secret operator는 helm secret과 고민중에 선택한것으로 helm secret보다는 복잡성이 덜할것, 그리고 argocd를 통하지 않아도 되는 부분과 많은 operator지원으로 특정 CSP제약이 덜하다는게 똑같다\n다만 helm secret보다는 복잡성때문에 진행해봤지만 이또한 tofu로 관리를 해야되는 문제 tofu또한 git으로 관리되는 문제로 gitops에서 secret 관리문제로 택했지만 이또한 git관리라 …\nhelm secret도 테스트를 해봐야할것같다.\n","wordCount":"319","inLanguage":"en","datePublished":"2024-05-23T17:10:06+09:00","dateModified":"2024-05-23T17:10:06+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://gobenpark.github.io/blog/secret/"},"publisher":{"@type":"Organization","name":"Ben Park","logo":{"@type":"ImageObject","url":"https://gobenpark.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gobenpark.github.io/ accesskey=h title="Ben Park (Alt + H)">Ben Park</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://gobenpark.github.io/blog/ title=blog><span>blog</span></a></li><li><a href=https://gobenpark.github.io/golang/ title=golang><span>golang</span></a></li><li><a href=https://gobenpark.github.io/remembrance/ title=remembrance><span>remembrance</span></a></li><li><a href=https://gobenpark.github.io/algorithm/ title=algorithm><span>algorithm</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">external secret 설치후기
<span class=entry-hint title=Draft><svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-05-23 17:10:06 +0900 KST'>May 23, 2024</span></div></header><div class=post-content><p>회사의 특정 GCP 프로젝트가 삭제되고 staging 환경에서 새로 argocd rollouts,linkerd, external secret operator등을 설치를 하려고한다.</p><p>개발환경에서 환경구축을 할 때 손수 매뉴얼하게 진행을 했었는데 이번에는 openTofu를 사용해서 진행을 해보았다</p><p>helm을 이용해서 external-secret operator를 설치</p><pre tabindex=0><code>helm install external-secrets \
   external-secrets/external-secrets \
    -n external-secrets \
    --create-namespace
</code></pre><p>이때 특정 ns(external-secrets)에 pod가 여러개가 생성이되고 해당 <a href=https://external-secrets.io/latest/provider/google-secrets-manager/>문서</a>에서 처럼 workload identity를 사용하여 gcp인증을 진행해야된다.</p><p>특정 서비스 어카운트를 생성하고 해당 어카운트에 workload identity user와 secret manager 엑세스 권한을 넣어주는것을 opentofu로 진행을 했다.</p><pre tabindex=0><code>resource &#34;google_service_account&#34; &#34;sa&#34; {
  account_id   = &#34;external-secrets&#34;
  display_name = &#34;external-secrets&#34;
  project      = var.project_id
}

resource &#34;google_service_account_iam_binding&#34; &#34;workload_identity_binding&#34; {
  service_account_id = google_service_account.sa.name
  role               = &#34;roles/iam.workloadIdentityUser&#34;
  members            = [
    &#34;serviceAccount:${var.project_id}.svc.id.goog[external-secrets/external-secrets]&#34;,
  ]
}

resource &#34;google_secret_manager_secret_iam_member&#34; &#34;secret_manager_access&#34;  {
  project = var.project_id
  secret_id = &#34;projects//secrets/github-token&#34;
  role = &#34;roles/secretmanager.secretAccessor&#34;
  member = &#34;serviceAccount:${google_service_account.sa.email}&#34;
}
</code></pre><p>해당 코드를 작성중 문뜩 개발환경을 말아먹은 때가 떠오르는데</p><p>당시 테라폼 코드를 작성중 서비스 어카운트 생성에 <a href=https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam#google_project_iam_policy>google_project_iam_policy</a>를 사용했었다 해당 문서에도 관련된 경고문구가 있었지만 당시에는 못보았다&mldr; 해당 리소스를 쓸경우 덮어씌워지는것도 아닌 내가 작성한 policy대로 초기화가된다. 즉 default service account는 물론 컴퓨트 엔진등 서비스 어카운트 모두 사라지게되니 조심하자.</p><p>해당 tf파일을 apply한후</p><p>kubernetes External secret과 secret store CRD를 모두 적용해주자</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>external-secrets.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ExternalSecret</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>github-token</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>refreshInterval</span>: <span style=color:#ae81ff>1h            </span> <span style=color:#75715e># rate SecretManager pulls GCPSM</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>secretStoreRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterSecretStore</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gcp-store              </span> <span style=color:#75715e># name of the SecretStore (or kind specified)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>target</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>database-credentials   </span> <span style=color:#75715e># name of the k8s Secret to be created</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>creationPolicy</span>: <span style=color:#ae81ff>Owner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>secretKey</span>: <span style=color:#ae81ff>github-token</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>remoteRef</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>key</span>: <span style=color:#ae81ff>github-token      # name of the GCPSM secret key   </span> <span style=color:#75715e># name of the GCPSM secret key</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>external-secrets.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterSecretStore</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>gcp-store</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>external-secrets</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>provider</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>gcpsm</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>projectID</span>: <span style=color:#e6db74>&#34;project&#34;</span> <span style=color:#75715e># config</span>
</span></span></code></pre></div><p>다음 두개의 내용을 apply를 하게되면</p><p>secret이 생성이 되고. 해당 secret은 gcp secret manager에 등록된 시크릿이 보이게된다.</p><p>external-secret operator는 helm secret과 고민중에 선택한것으로 helm secret보다는 복잡성이 덜할것, 그리고 argocd를 통하지 않아도 되는 부분과 많은 operator지원으로 특정 CSP제약이 덜하다는게 똑같다</p><p>다만 helm secret보다는 복잡성때문에 진행해봤지만 이또한 tofu로 관리를 해야되는 문제 tofu또한 git으로 관리되는 문제로 gitops에서 secret 관리문제로 택했지만 이또한 git관리라 &mldr;</p><p>helm secret도 테스트를 해봐야할것같다.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>Copyright © 2018–2024, BumwooPark; all rights reserved.</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>